#!/usr/bin/perl -w

=head1 NAME

qpxe-dhcpd - reload qPXE-controlled DHCPD configuration

=head1 SYNOPSIS

qpxe-dhcpd [options]

Options:

    -v,--verbose		Increase verbosity
    -q,--quiet			Decrease verbosity
    -h,--help			Display brief help message

=head1 DESCRIPTION

c<qpxe-dhcpd> regenerates the master include file C</etc/dhcpd.d.conf>
and restarts DHCPD.

=cut

use Getopt::Long;
use Pod::Usage;
use IO::Handle;
use Fcntl qw ( :flock :seek );
use strict;
use warnings;

# Parse command-line arguments
my $verbosity = 0;
GetOptions (
  'verbose|v+' => sub { $verbosity++ },
  'quiet|q+' => sub { $verbosity-- },
  'help|h' => sub { pod2usage ( 1 ) },
) or die "Could not parse command-line options\n";
pod2usage ( 1 ) if @ARGV;

# Calculate filenames
my $dirname = "/etc/dhcpd.d";
my $filename = "/etc/dhcpd.d.conf";

# Open include file and obtain lock
open ( my $fh, ">>", $filename )
    or die "Could not open ".$filename.": $!\n";
flock ( $fh, LOCK_EX )
    or die "Could not lock ".$filename.": $!\n";

# Generate include file data
my $data = ( "# This file is automatically generated by ".$0."\n".
	     "# Do not make manual changes to this file\n".
	     "#\n".
	     join ( "", map { "include \"".$_."\";\n" }
		    glob ( $dirname."/*.conf" ) ) );

# Write data to include file
$fh->setpos ( 0 );
$fh->truncate ( 0 );
$fh->print ( $data );
$fh->flush();

# Restart DHCPD
system ( "service", "dhcpd", "restart" ) == 0
    or die "Could not restart dhcpd: $?\n";

# Close include file
close ( $fh );
